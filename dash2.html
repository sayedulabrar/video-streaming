<!DOCTYPE html>
<html>
<head>
    <title>DASH Video Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/5.0.3/legacy/umd/dash.all.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f4f4f4;
        }
        #status {
            margin-top: 10px;
            color: #333;
        }
        .video-container {
            position: relative;
            width: 640px;
            height: 360px;
            background: black;
        }
        #videoPlayer {
            width: 100%;
            height: 100%;
            display: none;
        }
        .custom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            padding: 5px;
            box-sizing: border-box;
            z-index: 2147483647; /* High z-index for fullscreen */
            transition: opacity 0.3s;
            opacity: 1;
        }
        .video-container:hover .custom-controls {
            opacity: 1;
        }
        .custom-controls button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            margin: 0 5px;
        }
        .custom-controls button:hover {
            color: #ccc;
        }
        .progress-container {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
        }
        #progress {
            flex: 1;
            margin: 0 10px;
            -webkit-appearance: none;
            background: transparent;
            height: 5px;
        }
        #progress::-webkit-slider-runnable-track {
            background: #ddd;
            height: 5px;
        }
        #progress::-webkit-slider-thumb {
            -webkit-appearance: none;
            background: rgb(255, 255, 255);
            height: 15px;
            width: 15px;
            border-radius: 50%;
            margin-top: -5px;
            position: relative;
            z-index: 100;
        }
        #bufferProgress {
            position: absolute;
            left: 10px;
            right: 10px;
            height: 5px;
            background: #aaa;
            width: 0;
            pointer-events: none;
        }
        .volume-container {
            display: flex;
            align-items: center;
        }
        #volume {
            width: 80px;
            margin: 0 5px;
        }
        #qualitySelect, #speedSelect {
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            margin: 0 5px;
        }
        #qualitySelect option, #speedSelect option {
            background: black;
            color: white;
        }
        #timestamp {
            font-size: 12px;
            margin: 0 5px;
        }
        /* Fullscreen styles */
        .video-container.fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
        }
        #uploadForm, .folder-controls {
            margin-bottom: 15px;
        }
        button {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #folderInput {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #playingFolder {
            margin: 10px 0;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <h2>Video Streaming</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="videoFile" name="video" accept="video/*" required>
        <button type="submit">Upload Video</button>
    </form>
    <div class="folder-controls">
        <label for="folderInput"><strong>Folder Name:</strong></label>
        <input type="text" id="folderInput" placeholder="Enter folder name" />
        <button id="playBtn" type="button">Play Video</button>
    </div>
    <div id="status">No video available. Please upload a video.</div>
    <div id="playingFolder"></div>
    <div class="video-container" id="videoContainer">
        <video id="videoPlayer"></video> <!-- Removed controls attribute -->
        <div class="custom-controls" id="customControls" style="display: none;">
            <button id="playPauseBtn">‚ñ∂</button>
            <span id="timestamp">0:00 / 0:00</span>
            <div class="progress-container">
                <div id="bufferProgress"></div>
                <input type="range" id="progress" min="0" max="100" value="0">
            </div>
            <div class="volume-container">
                <button id="muteBtn">üîä</button>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="1">
            </div>
            <select id="speedSelect" onchange="changeSpeed()">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>Normal</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="1.75">1.75x</option>
                <option value="2">2x</option>
            </select>
            <select id="qualitySelect" onchange="changeQuality()">
                <option value="-1">Auto</option>
            </select>
            <button id="pipBtn" title="Picture-in-Picture">üñºÔ∏è</button>
            <button id="fullscreenBtn">‚õ∂</button>
        </div>
    </div>
    <script>
        const uploadForm = document.getElementById('uploadForm');
        const statusDiv = document.getElementById('status');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoContainer = document.getElementById('videoContainer');
        const customControls = document.getElementById('customControls');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progress = document.getElementById('progress');
        const bufferProgress = document.getElementById('bufferProgress');
        const muteBtn = document.getElementById('muteBtn');
        const volume = document.getElementById('volume');
        const timestamp = document.getElementById('timestamp');
        const qualitySelect = document.getElementById('qualitySelect');
        const speedSelect = document.getElementById('speedSelect');
        const pipBtn = document.getElementById('pipBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const folderInput = document.getElementById('folderInput');
        const playBtn = document.getElementById('playBtn');
        const playingFolder = document.getElementById('playingFolder');
        let player = null;
        let selectedFolder = "";
        let bitrates = [];
        let lastClickTime = 0;
        let clickCount = 0;
        let isSeeking = false;

        // Format time in mm:ss
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // Check if video.mpd exists and initialize player
        function checkAndInitPlayer() {
            if (!selectedFolder) return;
            const videoUrl = `http://localhost:3000/api/video/${selectedFolder}/video.mpd`;
            fetch(videoUrl)
                .then(response => {
                    if (response.ok) {
                        initializePlayer(videoUrl);
                    } else {
                        statusDiv.textContent = 'No video available in this folder. Please upload a video.';
                        videoPlayer.style.display = 'none';
                        customControls.style.display = 'none';
                    }
                })
                .catch(() => {
                    statusDiv.textContent = 'No video available in this folder. Please upload a video.';
                    videoPlayer.style.display = 'none';
                    customControls.style.display = 'none';
                });
        }

        // Handle video upload
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(uploadForm);
            statusDiv.textContent = 'Uploading video...';

            try {
                const response = await fetch('http://localhost:3000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (response.ok) {
                    const taskId = result.taskId;
                    statusDiv.textContent = `Video uploaded. Processing started (Task ID: ${taskId})`;
                    pollStatus(taskId);
                } else {
                    statusDiv.textContent = `Upload failed: ${result.error}`;
                }
            } catch (err) {
                statusDiv.textContent = `Upload error: ${err.message}`;
            }
        });

        // Poll processing status
        async function pollStatus(taskId) {
            const statusUrl = `http://localhost:3000/api/status/${taskId}`;
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(statusUrl);
                    const status = await response.json();

                    if (response.ok) {
                        statusDiv.textContent = status.message;
                        if (status.status === 'completed') {
                            clearInterval(interval);
                            checkAndInitPlayer();
                        } else if (status.status === 'failed') {
                            clearInterval(interval);
                        }
                    } else {
                        statusDiv.textContent = `Status check failed: ${status.error}`;
                        clearInterval(interval);
                    }
                } catch (err) {
                    statusDiv.textContent = `Status check error: ${err.message}`;
                    clearInterval(interval);
                }
            }, 2000);
        }

        // Initialize DASH player
        function initializePlayer(videoUrl) {
            if (player) {
                player.reset();
            }

            videoPlayer.style.display = 'block';

            player = dashjs.MediaPlayer().create();

            player.updateSettings({
                streaming: {
                    abr: {
                        autoSwitchBitrate: { video: false, audio: true }
                    }
                }
            });

            player.initialize(videoPlayer, videoUrl, false);

            qualitySelect.innerHTML = '<option value="-1">Auto</option>';

            player.on(dashjs.MediaPlayer.events.MANIFEST_LOADED, () => {
                player.setRepresentationForTypeByIndex('video', 0);
                qualitySelect.value = 0;
                console.log('MANIFEST_LOADED: forcing quality to 360p (index 0)');
            });

            player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                bitrates = player.getRepresentationsByType('video');
                console.log('Video qualities:', bitrates);
                bitrates.sort((a, b) => a.height - b.height);

                qualitySelect.innerHTML = '<option value="-1">Auto</option>';
                
                bitrates.forEach((br, index) => {
                    const label = `${br.height}p`;
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = label;
                    qualitySelect.appendChild(option);
                });

                customControls.style.display = 'flex';
                statusDiv.textContent = 'Video ready to play at 360p.';

                // Setup custom controls event listeners
                setupCustomControls();

                videoPlayer.play();
            });

            player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, (e) => {
                if (e.mediaType === 'video') {
                    const idx = bitrates.findIndex(br => br.index === e.newRepresentation.index);
                    qualitySelect.value = idx >= 0 ? idx : '-1';
                }
            });
        }




        // Setup custom controls
        function setupCustomControls() {
            // Play/Pause
            playPauseBtn.addEventListener('click', () => {
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    playPauseBtn.textContent = '‚ùö‚ùö';
                } else {
                    videoPlayer.pause();
                    playPauseBtn.textContent = '‚ñ∂';
                }
            });

            // Progress bar
            videoPlayer.addEventListener('timeupdate', () => {
                if (!isSeeking) {
                    progress.value = (videoPlayer.currentTime / videoPlayer.duration) * 100 || 0;
                }
                timestamp.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
            });

            // Buffer progress
            videoPlayer.addEventListener('progress', () => {
                if (videoPlayer.buffered.length > 0) {
                    const buffered = videoPlayer.buffered.end(0);
                    const bufferedPercent = (buffered / videoPlayer.duration) * 100;
                    bufferProgress.style.width = `${bufferedPercent}%`;
                }
            });

            progress.addEventListener('input', () => {
                isSeeking = true;
                const time = videoPlayer.duration * (progress.value / 100);
                videoPlayer.currentTime = time;
            });

            progress.addEventListener('change', () => {
                isSeeking = false;
            });

            // Mute
            muteBtn.addEventListener('click', () => {
                videoPlayer.muted = !videoPlayer.muted;
                muteBtn.textContent = videoPlayer.muted ? 'üîá' : 'üîä';
            });

            // Volume
            volume.addEventListener('input', () => {
                videoPlayer.volume = volume.value;
                videoPlayer.muted = volume.value === 0;
                muteBtn.textContent = volume.value === 0 ? 'üîá' : 'üîä';
            });

            // Picture-in-Picture
            pipBtn.addEventListener('click', async () => {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await videoPlayer.requestPictureInPicture();
                }
            });

            // Fullscreen
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            // Update play/pause button on play/pause events
            videoPlayer.addEventListener('play', () => {
                playPauseBtn.textContent = '‚ùö‚ùö';
            });
            videoPlayer.addEventListener('pause', () => {
                playPauseBtn.textContent = '‚ñ∂';
            });

            // Update max on progress when duration changes
            videoPlayer.addEventListener('loadedmetadata', () => {
                progress.max = 100;
                timestamp.textContent = `0:00 / ${formatTime(videoPlayer.duration)}`;
            });
        }

        // Change speed
        function changeSpeed() {
            videoPlayer.playbackRate = parseFloat(speedSelect.value);
        }

        // Toggle fullscreen on container
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
                videoContainer.classList.add('fullscreen');
            } else {
                document.exitFullscreen();
                videoContainer.classList.remove('fullscreen');
            }
        }

        // Handle fullscreen change
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                videoContainer.classList.remove('fullscreen');
            }
        });

        // Double-click seek
        videoPlayer.addEventListener('click', (event) => {
            const currentTime = new Date().getTime();
            const rect = videoPlayer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const videoWidth = rect.width;

            if (currentTime - lastClickTime < 300) {
                clickCount++;
            } else {
                clickCount = 1;
            }
            lastClickTime = currentTime;

            if (clickCount === 2) {
                if (clickX > videoWidth / 2) {
                    videoPlayer.currentTime = Math.min(videoPlayer.currentTime + 10, videoPlayer.duration);
                } else {
                    videoPlayer.currentTime = Math.max(videoPlayer.currentTime - 5, 0);
                }
                clickCount = 0;
            }
        });

        playBtn.addEventListener('click', () => {
            selectedFolder = folderInput.value.trim();
            if (selectedFolder) {
                playingFolder.textContent = `Playing from folder: ${selectedFolder}`;
                checkAndInitPlayer();
            } else {
                playingFolder.textContent = "";
                videoPlayer.style.display = 'none';
                customControls.style.display = 'none';
            }
        });

        // Change quality
        function changeQuality() {
            if (!player) return;

            const selectedIndex = parseInt(qualitySelect.value, 10);

            if (selectedIndex === -1) {
                player.updateSettings({
                    streaming: {
                        abr: {
                            autoSwitchBitrate: { video: true, audio: true }
                        }
                    }
                });
                statusDiv.textContent = 'Switched to Auto quality.';
            } else {
                player.updateSettings({
                    streaming: {
                        abr: {
                            autoSwitchBitrate: { video: false, audio: true }
                        }
                    }
                });
                player.setRepresentationForTypeByIndex('video', selectedIndex);
                statusDiv.textContent = `Switched to quality ${bitrates[selectedIndex].height}p.`;
            }
        }
    </script>
</body>
</html>