<!DOCTYPE html>
<html>
<head>
    <title>DASH Video Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/5.0.3/legacy/umd/dash.all.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #status {
            margin-top: 10px;
            color: #333;
        }
        #videoPlayer {
            width: 640px;
            height: 360px;
            display: none;
            background: black;
        }
        #qualitySelect {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h2>Video Streaming</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="videoFile" name="video" accept="video/*" required>
        <button type="submit">Upload Video</button>
    </form>
    <div style="margin-top: 15px;">
        <label for="folderInput"><strong>Folder Name:</strong></label>
        <input type="text" id="folderInput" placeholder="Enter folder name" />
        <button id="playBtn" type="button">Play Video</button>
    </div>
    <div id="status">No video available. Please upload a video.</div>
    <div id="playingFolder" style="margin: 10px 0; font-weight: bold;"></div>
    <video id="videoPlayer" controls></video>
    <div id="qualityControls" style="display: none;">
        <label for="qualitySelect">Select Quality: </label>
        <select id="qualitySelect" onchange="changeQuality()">
            <option value="-1">Auto</option>
        </select>
    </div>
    <script>
        const uploadForm = document.getElementById('uploadForm');
        const statusDiv = document.getElementById('status');
        const videoPlayer = document.getElementById('videoPlayer');
        const qualityControls = document.getElementById('qualityControls');
        const qualitySelect = document.getElementById('qualitySelect');
        const folderInput = document.getElementById('folderInput');
        const playBtn = document.getElementById('playBtn');
        const playingFolder = document.getElementById('playingFolder');
        let player = null;
        let selectedFolder = "";
        let bitrates = [];

        // Check if video.mpd exists on page load and initialize player
        function checkAndInitPlayer() {
            if (!selectedFolder) return;
            const videoUrl = `http://localhost:3000/api/video/${selectedFolder}/video.mpd`;
            fetch(videoUrl)
                .then(response => {
                    if (response.ok) {
                        initializePlayer(videoUrl);
                    } else {
                        statusDiv.textContent = 'No video available in this folder. Please upload a video.';
                        videoPlayer.style.display = 'none';
                        qualityControls.style.display = 'none';
                    }
                })
                .catch(() => {
                    statusDiv.textContent = 'No video available in this folder. Please upload a video.';
                    videoPlayer.style.display = 'none';
                    qualityControls.style.display = 'none';
                });
        }

        // Handle video upload
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(uploadForm);
            statusDiv.textContent = 'Uploading video...';

            try {
                const response = await fetch('http://localhost:3000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (response.ok) {
                    const taskId = result.taskId;
                    statusDiv.textContent = `Video uploaded. Processing started (Task ID: ${taskId})`;
                    pollStatus(taskId);
                } else {
                    statusDiv.textContent = `Upload failed: ${result.error}`;
                }
            } catch (err) {
                statusDiv.textContent = `Upload error: ${err.message}`;
            }
        });

        // Poll processing status
        async function pollStatus(taskId) {
            const statusUrl = `http://localhost:3000/api/status/${taskId}`;
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(statusUrl);
                    const status = await response.json();

                    if (response.ok) {
                        statusDiv.textContent = status.message;
                        if (status.status === 'completed') {
                            clearInterval(interval);
                            checkAndInitPlayer();
                        } else if (status.status === 'failed') {
                            clearInterval(interval);
                        }
                    } else {
                        statusDiv.textContent = `Status check failed: ${status.error}`;
                        clearInterval(interval);
                    }
                } catch (err) {
                    statusDiv.textContent = `Status check error: ${err.message}`;
                    clearInterval(interval);
                }
            }, 2000);
        }

        // Initialize DASH player and quality dropdown
        function initializePlayer(videoUrl) {
            if (player) {
                player.reset();
            }

            videoPlayer.style.display = 'block';

            player = dashjs.MediaPlayer().create();

            // Disable ABR early
            player.updateSettings({
                streaming: {
                    abr: {
                        autoSwitchBitrate: { video: false, audio: true }
                    }
                }
            });

            player.initialize(videoPlayer, videoUrl, false);

            qualitySelect.innerHTML = '<option value="-1">Auto</option>';

            // Set manual quality as soon as manifest is loaded
            player.on(dashjs.MediaPlayer.events.MANIFEST_LOADED, () => {
                player.setRepresentationForTypeByIndex('video', 0);
                qualitySelect.value = 0;
                console.log('MANIFEST_LOADED: forcing quality to 360p (index 0)');
            });

            player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                bitrates = player.getRepresentationsByType('video');
                console.log('Video qualities:', bitrates);
                bitrates.sort((a, b) => a.height - b.height);

                qualitySelect.innerHTML = '<option value="-1">Auto</option>';
                
                bitrates.forEach((br) => {
                    const label = `${br.height}p (${br.bitrateInKbit} kbps)`;
                    const option = document.createElement('option');
                    option.value = br.index;
                    option.textContent = label;
                    qualitySelect.appendChild(option);
                });

                qualityControls.style.display = 'block';
                statusDiv.textContent = 'Video ready to play at 360p.';

                videoPlayer.play();
            });

            player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, (e) => {
                if (e.mediaType === 'video') {
                    console.log("new quality", e.newRepresentation.index);
                    const idx = bitrates.findIndex(br => br.index === e.newRepresentation.index);
                    qualitySelect.value = idx >= 0 ? idx : '-1';
                }
            });
        }


        playBtn.addEventListener('click', () => {
            selectedFolder = folderInput.value.trim();
            if (selectedFolder) {
                playingFolder.textContent = `Playing from folder: ${selectedFolder}`;
                checkAndInitPlayer();
            } else {
                playingFolder.textContent = "";
                videoPlayer.style.display = 'none';
                qualityControls.style.display = 'none';
            }
        });

        // Change quality manually based on dropdown selection
        function changeQuality() {
            if (!player) return;

            const selectedIndex = parseInt(qualitySelect.value, 10); // This is now the array index

            if (selectedIndex === -1) {
                // Auto quality mode
                player.updateSettings({
                    streaming: {
                        abr: {
                            autoSwitchBitrate: { video: true, audio: true } // Enable auto-switching for video and audio [4]
                        }
                    }
                });
                statusDiv.textContent = 'Switched to Auto quality.';
            } else {
                // Manual quality mode
                player.updateSettings({
                    streaming: {
                        abr: {
                            autoSwitchBitrate: { video: false, audio: true } // Disable auto-switching for video, keep audio auto [4]
                        }
                    }
                });
                // Use setRepresentationForTypeByIndex with the array index [3]
                player.setRepresentationForTypeByIndex('video', selectedIndex);
                statusDiv.textContent = `Switched to quality index ${selectedIndex}.`;
            }
        }
    </script>
</body>
</html>
